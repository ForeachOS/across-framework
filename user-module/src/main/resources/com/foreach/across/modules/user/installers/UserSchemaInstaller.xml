<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

	<!-- Default table names -->
	<property name="table.permission" value="um_permission"/>
	<property name="table.permission_group" value="um_permission_group"/>
	<property name="table.role" value="um_role"/>
	<property name="table.role_permission" value="um_role_permission"/>
	<property name="table.user" value="um_user"/>
	<property name="table.user_role" value="um_user_role"/>

	<property name="long.type" value="bigint"/>
	<property name="varchar.suffix" value=""/>

	<property name="long.type" value="NUMBER(19,0)" dbms="oracle"/>
	<property name="varchar.suffix" value=" char" dbms="oracle"/>

	<changeSet id="201406121522" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.permission_group}"/>
			</not>
		</preConditions>

		<comment>Creates permission group table</comment>

		<createTable tableName="${table.permission_group}">
			<column name="id" type="${long.type}"/>
			<column name="name" type="varchar2(250 ${varchar.suffix})"/>
			<column name="title" type="varchar2(250 ${varchar.suffix})"/>
			<column name="description" type="varchar2(2000 ${varchar.suffix})"/>
		</createTable>

		<addPrimaryKey tableName="${table.permission_group}" columnNames="id"/>

		<createIndex tableName="${table.permission_group}" indexName="ix_um_perm_grp_name" unique="true">
			<column name="name"/>
		</createIndex>

		<insert tableName="ACROSS_SEQUENCES">
			<column name="seq_name">seq_um_permission_group_id</column>
			<column name="seq_number">100</column>
		</insert>
	</changeSet>

	<changeSet id="201403011520" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.permission}"/>
			</not>
		</preConditions>

		<comment>Creates permission table</comment>

		<createTable tableName="${table.permission}">
			<column name="id" type="${long.type}"/>
			<column name="name" type="varchar2(250 ${varchar.suffix})"/>
			<column name="description" type="varchar2(2000 ${varchar.suffix})"/>
			<column name="permission_group_id" type="${long.type}">
				<constraints nullable="false" referencedTableName="${table.permission_group}" referencedColumnNames="id"
				             foreignKeyName="fk_um_p_pg"/>
			</column>
		</createTable>

		<addPrimaryKey tableName="${table.permission}" columnNames="id"/>

		<createIndex tableName="${table.permission}" indexName="ix_um_permission_name" unique="true">
			<column name="name"/>
		</createIndex>

		<insert tableName="ACROSS_SEQUENCES">
			<column name="seq_name">seq_um_permission_id</column>
			<column name="seq_number">1000</column>
		</insert>
	</changeSet>

	<changeSet id="201403011521" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.role}"/>
			</not>
		</preConditions>

		<comment>Creates role and role_permission table</comment>

		<createTable tableName="${table.role}">
			<column name="id" type="${long.type}"/>
			<column name="name" type="varchar2(250 ${varchar.suffix})"/>
			<column name="description" type="varchar2(2000 ${varchar.suffix})"/>
		</createTable>

		<addPrimaryKey tableName="${table.role}" columnNames="id"/>

		<createIndex tableName="${table.role}" indexName="ix_um_role_name" unique="true">
			<column name="name"/>
		</createIndex>

		<insert tableName="ACROSS_SEQUENCES">
			<column name="seq_name">seq_um_role_id</column>
			<column name="seq_number">1000</column>
		</insert>

		<createTable tableName="${table.role_permission}">
			<column name="role_id" type="${long.type}"/>
			<column name="permission_id" type="${long.type}"/>
		</createTable>

		<addPrimaryKey constraintName="pk_um_role_permission" tableName="${table.role_permission}"
		               columnNames="role_id, permission_id"/>

		<addForeignKeyConstraint baseTableName="${table.role_permission}" baseColumnNames="role_id"
		                         constraintName="fk_um_rp_role_id"
		                         referencedTableName="${table.role}"
		                         referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="${table.role_permission}" baseColumnNames="permission_id"
		                         constraintName="fk_um_rp_permission_id"
		                         referencedTableName="${table.permission}"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="201405021433" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.user}"/>
			</not>
		</preConditions>

		<comment>Create user table</comment>

		<createTable tableName="${table.user}">
			<column name="id" type="${long.type}"/>
			<column name="username" type="varchar2(255 ${varchar.suffix})"/>
			<column name="email" type="varchar2(320 ${varchar.suffix})"/>
			<column name="password" type="varchar2(250 ${varchar.suffix})"/>
		</createTable>

		<addPrimaryKey tableName="${table.user}" columnNames="id"/>

		<addNotNullConstraint tableName="${table.user}" columnName="username"
		                      columnDataType="varchar2(320 ${varchar.suffix})"/>

		<createIndex tableName="${table.user}" indexName="ix_um_user_username" unique="true">
			<column name="username"/>
		</createIndex>

		<insert tableName="ACROSS_SEQUENCES">
			<column name="seq_name">seq_um_user_id</column>
			<column name="seq_number">1000</column>
		</insert>

	</changeSet>

	<changeSet id="201406122032" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.user_role}"/>
			</not>
		</preConditions>

		<comment>Create user role table</comment>

		<createTable tableName="${table.user_role}">
			<column name="user_id" type="${long.type}"/>
			<column name="role_id" type="${long.type}"/>
		</createTable>

		<addPrimaryKey tableName="${table.user_role}" columnNames="user_id, role_id"/>

		<addForeignKeyConstraint baseTableName="${table.user_role}" baseColumnNames="user_id"
		                         constraintName="fk_um_ur_user_id"
		                         referencedTableName="${table.user}"
		                         referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="${table.user_role}" baseColumnNames="role_id"
		                         constraintName="fk_um_ur_role_id"
		                         referencedTableName="${table.role}"
		                         referencedColumnNames="id"/>
	</changeSet>
</databaseChangeLog>